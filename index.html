<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>test</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ë§‘ì€ ê³ ë”•", helvetica,
                    "Apple SD Gothic Neo", sans-serif;
                background-color: #ffffff;
                color: #000000;
                margin: 0;
                padding: 20px;
                line-height: 1.5;
                min-height: 100vh;
            }

            .main-layout {
                display: flex;
                gap: 30px;
                max-width: 1400px;
                margin: 0 auto;
                min-height: calc(100vh - 40px);
            }

            .map-section {
                flex: 1;
                min-width: 400px;
            }

            .content-section {
                flex: 1;
                min-width: 400px;
            }

            .container {
                text-align: center;
                padding: 40px;
                border-radius: 8px;
                background-color: #ffffff;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                width: 100%;
                height: fit-content;
            }

            .map-container {
                background-color: #ffffff;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                padding: 20px;
                height: fit-content;
                min-height: 600px;
            }

            .map-title {
                font-size: 24px;
                font-weight: 700;
                color: #03c75a;
                margin-bottom: 20px;
                text-align: center;
            }

            #map {
                width: 100%;
                height: 500px;
                border-radius: 8px;
                border: 2px solid #e9ecef;
            }

            @media (max-width: 1024px) {
                .main-layout {
                    flex-direction: column;
                    gap: 20px;
                }

                .map-section,
                .content-section {
                    min-width: auto;
                }

                #map {
                    height: 400px;
                }
            }

            .main-title {
                font-size: 64px;
                font-weight: 700;
                color: #dc3545;
                margin-bottom: 20px;
                letter-spacing: -1px;
            }

            .subtitle {
                font-size: 16px;
                color: #666666;
                margin-bottom: 30px;
                font-weight: 400;
            }

            .divider {
                width: 60px;
                height: 2px;
                background-color: #03c75a;
                margin: 0 auto 30px;
            }

            .description {
                font-size: 14px;
                color: #888888;
                line-height: 1.6;
            }

            @media (max-width: 768px) {
                .main-title {
                    font-size: 48px;
                }

                .container {
                    padding: 30px 20px;
                    margin: 20px;
                }
            }

            @media (max-width: 480px) {
                .main-title {
                    font-size: 36px;
                }
            }

            /* ë„¤ì´ë²„ ìŠ¤íƒ€ì¼ì˜ ë¯¸ë¬˜í•œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
            .container {
                animation: fadeIn 0.8s ease-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .main-title {
                transition: transform 0.3s ease;
            }

            .main-title:hover {
                transform: scale(1.05);
            }

            /* íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
            .upload-section {
                margin: 30px 0;
            }

            .upload-area {
                border: 2px dashed #03c75a;
                border-radius: 8px;
                padding: 40px 20px;
                text-align: center;
                background-color: #f8fff9;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .upload-area:hover {
                background-color: #f0fff0;
                border-color: #02b050;
            }

            .upload-area.dragover {
                background-color: #e8f5e8;
                border-color: #02b050;
                transform: scale(1.02);
            }

            .upload-icon {
                font-size: 48px;
                margin-bottom: 10px;
            }

            .upload-text {
                color: #666;
                margin-bottom: 15px;
                font-size: 14px;
            }

            .upload-btn {
                background-color: #03c75a;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background-color 0.3s ease;
            }

            .upload-btn:hover {
                background-color: #02b050;
            }

            .upload-progress {
                margin-top: 20px;
            }

            .progress-bar {
                width: 100%;
                height: 6px;
                background-color: #e9ecef;
                border-radius: 3px;
                overflow: hidden;
                margin-bottom: 10px;
            }

            .progress-fill {
                height: 100%;
                background-color: #03c75a;
                width: 0%;
                transition: width 0.3s ease;
            }

            /* íŒŒì¼ ëª©ë¡ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
            .files-section {
                margin-top: 40px;
            }

            .section-title {
                font-size: 20px;
                color: #333;
                margin-bottom: 20px;
                text-align: left;
            }

            .files-list {
                background-color: #f8f9fa;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                min-height: 200px;
                max-height: 400px;
                overflow-y: auto;
            }

            .file-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 16px;
                margin-bottom: 8px;
                background-color: white;
                border-radius: 6px;
                border: 1px solid #e9ecef;
                transition: all 0.2s ease;
            }

            .file-item:hover {
                border-color: #03c75a;
                box-shadow: 0 2px 4px rgba(3, 199, 90, 0.1);
            }

            .file-info {
                flex: 1;
                text-align: left;
            }

            .file-name {
                font-weight: 600;
                color: #333;
                margin-bottom: 4px;
            }

            .file-details {
                font-size: 12px;
                color: #666;
            }

            .file-actions {
                display: flex;
                gap: 8px;
            }

            .action-btn {
                padding: 6px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: all 0.2s ease;
            }

            .download-btn {
                background-color: #03c75a;
                color: white;
            }

            .download-btn:hover {
                background-color: #02b050;
            }

            .delete-btn {
                background-color: #dc3545;
                color: white;
            }

            .delete-btn:hover {
                background-color: #c82333;
            }

            .refresh-btn {
                background-color: #6c757d;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background-color 0.3s ease;
            }

            .refresh-btn:hover {
                background-color: #5a6268;
            }

            .empty-state {
                text-align: center;
                color: #666;
                font-style: italic;
                padding: 40px 20px;
            }

            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }

            .notification.show {
                transform: translateX(0);
            }

            .notification.success {
                background-color: #28a745;
            }

            .notification.error {
                background-color: #dc3545;
            }
        </style>
        <!-- ì¹´ì¹´ì˜¤ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸ -->
        <script
            type="text/javascript"
            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e6d1213031529597da18dae5ea957ec9"
        ></script>
    </head>
    <body>
        <div class="main-layout">
            <!-- ì§€ë„ ì„¹ì…˜ -->
            <div class="map-section">
                <div class="map-container">
                    <h2 class="map-title">ğŸ“ ìœ„ì¹˜ ì •ë³´</h2>
                    <div id="map"></div>
                    <div style="margin-top: 15px; text-align: center">
                        <p style="color: #666; font-size: 14px">ì¹´ì¹´ì˜¤ ì§€ë„ APIë¥¼ ì‚¬ìš©í•œ ì§€ë„ ì„œë¹„ìŠ¤</p>
                    </div>
                </div>
            </div>

            <!-- ì»¨í…ì¸  ì„¹ì…˜ -->
            <div class="content-section">
                <div class="container">
                    <h1 class="main-title">test</h1>
                    <div class="divider"></div>
                    <p class="subtitle">íŒŒì¼ ì—…ë¡œë“œ & ë‹¤ìš´ë¡œë“œ ì„œë¹„ìŠ¤</p>

                    <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
                    <div class="upload-section">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">ğŸ“</div>
                            <p class="upload-text">íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                            <input type="file" id="fileInput" multiple style="display: none" />
                            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                                íŒŒì¼ ì„ íƒ
                            </button>
                        </div>
                        <div id="uploadProgress" class="upload-progress" style="display: none">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <p id="progressText">ì—…ë¡œë“œ ì¤‘...</p>
                        </div>
                    </div>

                    <!-- íŒŒì¼ ëª©ë¡ ì„¹ì…˜ -->
                    <div class="files-section">
                        <h3 class="section-title">ì—…ë¡œë“œëœ íŒŒì¼</h3>
                        <div id="filesList" class="files-list">
                            <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        <button class="refresh-btn" onclick="loadFiles()">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ì „ì—­ ë³€ìˆ˜
            let uploadArea = document.getElementById("uploadArea");
            let fileInput = document.getElementById("fileInput");
            let filesList = document.getElementById("filesList");
            let uploadProgress = document.getElementById("uploadProgress");
            let progressFill = document.getElementById("progressFill");
            let progressText = document.getElementById("progressText");

            // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ì§€ë„ ì´ˆê¸°í™”
            document.addEventListener("DOMContentLoaded", function () {
                loadFiles();

                // ì¹´ì¹´ì˜¤ ì§€ë„ APIê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ì´ˆê¸°í™”
                if (typeof kakao !== "undefined") {
                    initializeMap();
                } else {
                    // 1ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„
                    setTimeout(function () {
                        if (typeof kakao !== "undefined") {
                            initializeMap();
                        } else {
                            // 2ì´ˆ í›„ í•œ ë²ˆ ë” ì‹œë„
                            setTimeout(function () {
                                initializeMap();
                            }, 2000);
                        }
                    }, 1000);
                }
            });

            // ì¹´ì¹´ì˜¤ ì§€ë„ ì´ˆê¸°í™”
            function initializeMap() {
                // kakao ê°ì²´ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (typeof kakao === "undefined") {
                    console.error("ì¹´ì¹´ì˜¤ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    showMapError("ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë”© ì‹¤íŒ¨", "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    return;
                }

                try {
                    var container = document.getElementById("map");

                    if (!container) {
                        console.error("ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    var options = {
                        center: new kakao.maps.LatLng(37.566826, 126.9786567), // ì„œìš¸ì‹œì²­ ì¢Œí‘œ
                        level: 3, // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                    };

                    var map = new kakao.maps.Map(container, options);

                    // ë§ˆì»¤ ìƒì„±
                    var markerPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
                    var marker = new kakao.maps.Marker({
                        position: markerPosition,
                    });

                    // ë§ˆì»¤ë¥¼ ì§€ë„ì— í‘œì‹œ
                    marker.setMap(map);

                    // ì¸í¬ìœˆë„ìš° ìƒì„±
                    var infowindow = new kakao.maps.InfoWindow({
                        content: '<div style="padding:5px; font-size:12px;">testì˜ íŒŒì¼ ì„œë²„ ğŸ“</div>',
                    });

                    // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                    kakao.maps.event.addListener(marker, "click", function () {
                        infowindow.open(map, marker);
                    });

                    console.log("ì§€ë„ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");

                    // ì„±ê³µ ì•Œë¦¼
                    showNotification("ì§€ë„ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ—ºï¸", "success");
                } catch (error) {
                    console.error("ì§€ë„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);

                    if (error.message.includes("APIí‚¤")) {
                        showMapError("API í‚¤ ì˜¤ë¥˜", "ì¹´ì¹´ì˜¤ ê°œë°œì ì‚¬ì´íŠ¸ì—ì„œ ë„ë©”ì¸ ë“±ë¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    } else {
                        showMapError("ì§€ë„ ë¡œë”© ì˜¤ë¥˜", error.message);
                    }
                }
            }

            // ì§€ë„ ì˜¤ë¥˜ í‘œì‹œ í•¨ìˆ˜
            function showMapError(title, message) {
                var mapContainer = document.getElementById("map");
                mapContainer.innerHTML = `
                 <div style="display: flex; align-items: center; justify-content: center; height: 100%; background-color: #f8f9fa; border-radius: 6px; flex-direction: column; padding: 20px;">
                     <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                     <h3 style="color: #dc3545; margin-bottom: 10px;">${title}</h3>
                     <p style="color: #666; text-align: center; font-size: 14px; line-height: 1.5; margin-bottom: 20px;">
                         ${message}
                     </p>
                     <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; font-size: 12px; color: #856404;">
                         <strong>í•´ê²° ë°©ë²•:</strong><br>
                         1. <a href="https://developers.kakao.com" target="_blank" style="color: #03c75a;">ì¹´ì¹´ì˜¤ ê°œë°œì ì‚¬ì´íŠ¸</a> â†’ ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜<br>
                         2. í”Œë«í¼ ì„¤ì • â†’ Web í”Œë«í¼ì— <code>http://localhost:3000</code> ë“±ë¡<br>
                         3. JavaScript í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸<br>
                         4. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (Ctrl + F5)
                     </div>
                 </div>
             `;
            }

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
            uploadArea.addEventListener("dragover", function (e) {
                e.preventDefault();
                uploadArea.classList.add("dragover");
            });

            uploadArea.addEventListener("dragleave", function (e) {
                e.preventDefault();
                uploadArea.classList.remove("dragover");
            });

            uploadArea.addEventListener("drop", function (e) {
                e.preventDefault();
                uploadArea.classList.remove("dragover");

                const files = Array.from(e.dataTransfer.files);
                uploadFiles(files);
            });

            // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ì²˜ë¦¬
            fileInput.addEventListener("change", function (e) {
                const files = Array.from(e.target.files);
                uploadFiles(files);
            });

            // íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
            async function uploadFiles(files) {
                if (files.length === 0) return;

                for (let file of files) {
                    await uploadSingleFile(file);
                }

                // ì—…ë¡œë“œ ì™„ë£Œ í›„ íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadFiles();
            }

            // ë‹¨ì¼ íŒŒì¼ ì—…ë¡œë“œ
            async function uploadSingleFile(file) {
                const formData = new FormData();
                formData.append("file", file);

                try {
                    showProgress();
                    updateProgress(0, `${file.name} ì—…ë¡œë“œ ì¤‘...`);

                    const response = await fetch("/api/upload", {
                        method: "POST",
                        body: formData,
                    });

                    const result = await response.json();

                    if (response.ok) {
                        updateProgress(100, "ì—…ë¡œë“œ ì™„ë£Œ!");
                        showNotification(result.message, "success");
                        setTimeout(hideProgress, 2000);
                    } else {
                        throw new Error(result.error || "ì—…ë¡œë“œ ì‹¤íŒ¨");
                    }
                } catch (error) {
                    console.error("Upload error:", error);
                    showNotification("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message, "error");
                    hideProgress();
                }
            }

            // íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            async function loadFiles() {
                try {
                    const response = await fetch("/api/files");
                    const files = await response.json();

                    displayFiles(files);
                } catch (error) {
                    console.error("Load files error:", error);
                    showNotification("íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                }
            }

            // íŒŒì¼ ëª©ë¡ í‘œì‹œ
            function displayFiles(files) {
                filesList.innerHTML = "";

                if (files.length === 0) {
                    filesList.innerHTML = '<div class="empty-state">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                files.forEach((file) => {
                    const fileItem = createFileItem(file);
                    filesList.appendChild(fileItem);
                });
            }

            // íŒŒì¼ ì•„ì´í…œ ìƒì„±
            function createFileItem(file) {
                const div = document.createElement("div");
                div.className = "file-item";

                const fileSize = formatFileSize(file.size);
                const uploadDate = new Date(file.uploadDate).toLocaleString("ko-KR");

                div.innerHTML = `
                 <div class="file-info">
                     <div class="file-name">${escapeHtml(file.originalName)}</div>
                     <div class="file-details">${fileSize} â€¢ ${uploadDate}</div>
                 </div>
                 <div class="file-actions">
                     <button class="action-btn download-btn" onclick="downloadFile('${encodeURIComponent(
                         file.filename
                     )}', '${escapeHtml(file.originalName)}')">
                         ë‹¤ìš´ë¡œë“œ
                     </button>
                     <button class="action-btn delete-btn" onclick="deleteFile('${encodeURIComponent(file.filename)}')">
                         ì‚­ì œ
                     </button>
                 </div>
             `;

                return div;
            }

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            function downloadFile(filename, originalName) {
                const link = document.createElement("a");
                link.href = `/api/download/${filename}`;
                link.download = originalName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification("íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.", "success");
            }

            // íŒŒì¼ ì‚­ì œ
            async function deleteFile(filename) {
                if (!confirm("ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    return;
                }

                try {
                    const response = await fetch(`/api/files/${filename}`, {
                        method: "DELETE",
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showNotification(result.message, "success");
                        loadFiles(); // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        throw new Error(result.error || "ì‚­ì œ ì‹¤íŒ¨");
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                    showNotification("íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message, "error");
                }
            }

            // ì§„í–‰ë¥  í‘œì‹œ
            function showProgress() {
                uploadProgress.style.display = "block";
            }

            function hideProgress() {
                uploadProgress.style.display = "none";
                progressFill.style.width = "0%";
            }

            function updateProgress(percent, text) {
                progressFill.style.width = percent + "%";
                progressText.textContent = text;
            }

            // ì•Œë¦¼ í‘œì‹œ
            function showNotification(message, type = "success") {
                // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
                const existingNotification = document.querySelector(".notification");
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement("div");
                notification.className = `notification ${type}`;
                notification.textContent = message;

                document.body.appendChild(notification);

                // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ì§€ì—°
                setTimeout(() => {
                    notification.classList.add("show");
                }, 100);

                // 3ì´ˆ í›„ ìë™ ì œê±°
                setTimeout(() => {
                    notification.classList.remove("show");
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
            function formatFileSize(bytes) {
                if (bytes === 0) return "0 Bytes";

                const k = 1024;
                const sizes = ["Bytes", "KB", "MB", "GB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));

                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
            }

            // HTML ì´ìŠ¤ì¼€ì´í”„
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    </body>
</html>
